# ============================================================
# SSL/TLS CONFIGURATION
# ============================================================
# Modern SSL configuration with strong security
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
ssl_prefer_server_ciphers off;

# SSL session cache for performance
ssl_session_cache shared:SSL:50m;
ssl_session_timeout 10m;
ssl_session_tickets off;

# OCSP Stapling for faster certificate validation
ssl_stapling on;
ssl_stapling_verify on;

# DNS resolvers for OCSP stapling (Google DNS + Cloudflare DNS)
resolver 8.8.8.8 8.8.4.4 1.1.1.1 1.0.0.1 valid=300s;
resolver_timeout 5s;

# DH parameters for forward secrecy
ssl_dhparam /etc/nginx/ssl/dhparam.pem;

# ============================================================
# IP-BASED RATE LIMITING ZONES (ENHANCED)
# ============================================================
# NOTE: Nginx supports only r/s (per second) and r/m (per minute)
# For hourly rates, convert: 3 req/hour ≈ 1 req/20min → use 1r/m with large burst

# General rate limiting by IP
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;

# API endpoints - higher rate limit
limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;

# Aggressive API rate limit for suspicious IPs
limit_req_zone $binary_remote_addr zone=api_strict:10m rate=10r/s;

# Login attempts - very strict (5 per minute)
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;

# Registration - prevent spam bots (1 per minute with burst for legitimate use)
limit_req_zone $binary_remote_addr zone=register:10m rate=1r/m;

# Password reset - prevent abuse (1 per minute with burst)
limit_req_zone $binary_remote_addr zone=password_reset:10m rate=1r/m;

# Admin panel access - strict but reasonable
limit_req_zone $binary_remote_addr zone=admin:10m rate=20r/m;

# File uploads - prevent DoS
limit_req_zone $binary_remote_addr zone=upload:10m rate=10r/m;

# Download endpoints - prevent scraping
limit_req_zone $binary_remote_addr zone=download:10m rate=30r/m;

# Search functionality - prevent abuse
limit_req_zone $binary_remote_addr zone=search:10m rate=20r/m;

# Connection limiting by IP
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Per-IP bandwidth limiting zone
limit_conn_zone $binary_remote_addr zone=perip:10m;

# ============================================================
# BAD BOT DETECTION & BLOCKING
# ============================================================

# Map to detect bad bots and scrapers
map $http_user_agent $bad_bot {
    default 0;

    # Empty or missing user agent
    "" 1;

    # Known malicious bots
    ~*^$ 1;
    ~*masscan 1;
    ~*zmap 1;
    ~*nikto 1;
    ~*sqlmap 1;
    ~*nmap 1;
    ~*acunetix 1;
    ~*scanner 1;
    ~*havij 1;
    ~*zgrab 1;
    ~*Go-http-client 1;
    ~*python-requests 1;
    ~*curl 1;
    ~*wget 1;

    # Aggressive scrapers
    ~*semrush 1;
    ~*ahrefs 1;
    ~*dotbot 1;
    ~*mj12bot 1;
    ~*majestic 1;
    ~*ahrefsbot 1;
    ~*blexbot 1;

    # Spam bots
    ~*emailcollector 1;
    ~*emailsiphon 1;
    ~*email.*collector 1;
    ~*grub 1;
}

# Map to detect suspicious requests
map $request_method $suspicious_method {
    default 0;
    TRACE 1;
    DELETE 1;
    CONNECT 1;
}

# Map to detect common attack patterns in URI
# ============================================================
# MAP: ATTACK PATTERN DETECTION (ENHANCED)
# ============================================================
# ============================================================
# MAP: ATTACK PATTERN DETECTION (ENHANCED)
# ============================================================
map $request_uri $attack_pattern {
    default 0;

    # ============================================================
    # SQL INJECTION PATTERNS
    # ============================================================
    "~*union[\s\+]+select"              1;
    "~*union[\s\+]+all[\s\+]+select"    1;
    "~*select[\s\+].*[\s\+]from[\s\+]"  1;
    "~*insert[\s\+]+into[\s\+]"         1;
    "~*delete[\s\+]+from[\s\+]"         1;
    "~*drop[\s\+]+(table|database|column)" 1;
    "~*update[\s\+].*[\s\+]set[\s\+]"   1;
    "~*alter[\s\+]+table"               1;
    "~*create[\s\+]+table"              1;
    "~*exec[\s\+]*\("                   1;
    "~*execute[\s\+]*\("                1;
    "~*declare[\s\+].*[\s\+]cursor"     1;

    # SQL functions
    "~*concat[\s\+]*\("                 1;
    "~*load_file[\s\+]*\("              1;
    "~*into[\s\+]+outfile"              1;
    "~*into[\s\+]+dumpfile"             1;
    "~*benchmark[\s\+]*\("              1;
    "~*sleep[\s\+]*\("                  1;
    "~*waitfor[\s\+]+delay"             1;
    "~*base64_decode[\s\+]*\("          1;
    ~*information_schema                1;
    "~*sys\."                           1;
    "~*mysql\."                         1;

    # SQL comments
    "~*/\*.*\*/"                        1;
    "~*--[\s]+"                         1;
    "~*\#[\s]+"                         1;

    # SQL operators
    "~*'[\s]*(or|and|xor)[\s]*'?[\s]*[=\(]" 1;
    "~*\"[\s]*(or|and|xor)[\s]*\"?[\s]*[=\(]" 1;
    "~*'[\s]*\d+[\s]*=[\s]*\d+"         1;
    "~*1[\s]*=[\s]*1"                   1;

    # URL-encoded SQL
    "~*%27(union|select|insert|update|delete|drop|create|alter)" 1;
    "~*%2527(union|select|insert|update|delete)" 1;
    "~*0x[0-9a-f]+(union|select)"       1;

    # ============================================================
    # PATH TRAVERSAL
    # ============================================================
    "~*\.\./\.\."                       1;
    "~*\.\./.*\.\."                     1;
    "~*\.\./etc/passwd"                 1;
    "~*\.\./etc/shadow"                 1;
    "~*\.\./proc/self"                  1;
    "~*\.\./windows/system32"           1;

    # URL-encoded traversal
    "~*\.\.%2[fF]"                      1;
    "~*\.\.%5[cC]"                      1;
    "~*%2e%2e%2[fF]"                    1;
    "~*%2e%2e%5[cC]"                    1;
    "~*\.\.%252[fF]"                    1;
    "~*\.\.%255[cC]"                    1;
    "~*\.\.%c0%af"                      1;
    "~*\.\.%c1%9c"                      1;

    # ============================================================
    # FILE INCLUSION (LFI/RFI)
    # ============================================================
    ~*php://input                       1;
    ~*php://filter                      1;
    ~*data://text                       1;
    ~*data:text/html                    1;
    ~*file://                           1;
    ~*glob://                           1;
    ~*phar://                           1;
    ~*expect://                         1;
    ~*zip://                            1;
    "~*[?&]file="                       1;
    "~*[?&]page=http"                   1;
    "~*[?&]include="                    1;
    "~*[?&]path=http"                   1;

    # ============================================================
    # COMMAND INJECTION
    # ============================================================
    "~*[\s;|`]cat[\s/]"                 1;
    "~*[\s;|`]ls[\s-]"                  1;
    "~*[\s;|`]wget[\s]"                 1;
    "~*[\s;|`]curl[\s]"                 1;
    "~*[\s;|`]nc[\s]"                   1;
    "~*[\s;|`]netcat[\s]"               1;
    "~*[\s;|`]bash[\s]"                 1;
    "~*[\s;|`]sh[\s]"                   1;
    "~*[\s;|`]chmod[\s]"                1;
    "~*[\s;|`]chown[\s]"                1;
    "~*[\s;|`]python[\s]"               1;
    "~*[\s;|`]perl[\s]"                 1;
    "~*[\s;|`]ruby[\s]"                 1;
    "~*[\s;|`]powershell[\s]"           1;
    "~*[\s;|`]cmd[\s]"                  1;

    # Command execution
    "~*\$\{.*\}"                        1;
    "~*\$\(.*\)"                        1;
    "~*`.*`"                            1;

    # URL-encoded commands
    "~*%0a(cat|wget|curl|bash|sh)"     1;
    "~*%0d(cat|wget|curl|bash|sh)"     1;
    "~*%3b(cat|wget|curl|bash|sh)"     1;
    "~*%7c(cat|wget|curl|bash|sh)"     1;

    # ============================================================
    # XSS
    # ============================================================
    "~*<script[^>]*>"                   1;
    "~*</script>"                       1;
    ~*%3cscript                         1;
    "~*%3c%2fscript"                    1;
    "~*on(error|load|click|mouse|focus|blur)[\s]*=" 1;
    ~*javascript:                       1;
    ~*vbscript:                         1;
    ~*<iframe                           1;
    ~*<embed                            1;
    ~*<object                           1;
    "~*<img[^>]+src"                    1;
    "~*<svg[^>]+onload"                 1;
    ~*%3ciframe                         1;
    ~*%3cembed                          1;
    ~*%3cobject                         1;

    # ============================================================
    # NULL BYTE & SPECIAL INJECTIONS
    # ============================================================
    ~*%00                               1;
    "~*\\x00"                           1;
    "~*\\0"                             1;
    "~*\(\|.*\)"                        1;
    "~*\(\&.*\)"                        1;
    "~*\(\!.*\)"                        1;
    ~*<!DOCTYPE                         1;
    ~*<!ENTITY                          1;
    "~*SYSTEM[\s]+\"file:"              1;
    "~*@(localhost|127\.0\.0\.1|0\.0\.0\.0)" 1;
    ~*file:///etc                       1;
    ~*gopher://                         1;
    ~*dict://                           1;

    # ============================================================
    # SENSITIVE FILES
    # ============================================================
    "~*\.git/(config|HEAD)"             1;
    "~*\.env$"                          1;
    "~*\.env\."                         1;
    "~*\.ssh/"                          1;
    ~*id_rsa                            1;
    "~*\.aws/"                          1;
    "~*wp-config\.php"                  1;
    "~*web\.config"                     1;
    "~*\.htaccess"                      1;
    "~*\.htpasswd"                      1;
    "~*database\.yml"                   1;
    "~*config\.json"                    1;
    "~*\.npmrc"                         1;
    "~*\.dockerenv"                     1;

    # ============================================================
    # CMS EXPLOITS
    # ============================================================
    ~*phpMyAdmin                        1;
    ~*phpmyadmin                        1;
    ~*pma/                              1;
    ~*wp-admin                          1;
    ~*wp-login                          1;
    ~*wp-includes                       1;
    "~*xmlrpc\.php"                     1;
    "~*admin-ajax\.php"                 1;
    ~*joomla/administrator              1;
    ~*administrator/components          1;
    ~*/magento/                         1;
    ~*/mage/                            1;

    # ============================================================
    # BACKUP FILES
    # ============================================================
    "~*\.(bak|backup|old|orig|save|tmp|temp|swp)$" 1;
    "~*~$"                              1;
    "~*\.sql$"                          1;
    "~*\.gz$"                           1;
    "~*\.tar$"                          1;
    "~*\.zip$"                          1;
    "~*\.rar$"                          1;
    "~*\.7z$"                           1;
    "~*%25(2e|2f|5c)"                   1;
    ~*%252e                             1;
    ~*%252f                             1;
    ~*%255c                             1;
}

# ============================================================
# LARAVEL-SPECIFIC ATTACK PATTERNS
# ============================================================
map $request_uri $laravel_attack {
    default 0;

    # Debug & Admin Tools
    ~*/telescope                        1;
    ~*/horizon                          1;
    ~*/nova-api/                        1;
    ~*/_ignition/                       1;
    ~*/_debugbar                        1;
    ~*/__clockwork/                     1;

    # Framework Directories
    ~*/bootstrap/cache/                 1;
    "~*/bootstrap/app\.php"             1;
    ~*/storage/framework/               1;
    ~*/storage/logs/                    1;
    ~*/storage/app/private              1;
    ~*/vendor/                          1;
    "~*/artisan$"                       1;
    "~*/server\.php$"                   1;

    # Environment & Config Files
    "~*\.env$"                          1;
    "~*\.env\."                         1;
    "~*/config/.*\.php"                 1;
    "~*/database/.*\.php"               1;
    "~*/database/.*\.sql"               1;
    "~*/database/.*\.sqlite"            1;
    "~*\.sqlite$"                       1;
    "~*/composer\.(json|lock)"          1;
    "~*/composer\.phar"                 1;
    "~*/package\.json"                  1;
    "~*/package-lock\.json"             1;
    "~*/yarn\.lock"                     1;
    "~*/webpack\.mix\.js"               1;
    "~*/vite\.config\.js"               1;
    "~*/phpunit\.xml"                   1;
    "~*\.phpunit\.result\.cache"        1;
    ~*/tests/                           1;

    # Laravel Routing
    "~*/routes/.*\.php"                 1;
    ~*/_dusk/                           1;
    ~*/_testing/                        1;
    "~*/broadcasting/auth(?:\?|$)"      1;

    # Sessions & Cache
    ~*/storage/framework/sessions/      1;
    ~*/storage/framework/cache/         1;
    ~*/storage/framework/views/         1;

    # Log Files
    "~*laravel\.log"                    1;
    "~*laravel-[0-9]{4}-[0-9]{2}-[0-9]{2}\.log" 1;
    ~*error_log                         1;
    "~*error\.log"                      1;
    "~*\.log$"                          1;

    # Backups
    "~*dump\.sql"                       1;
    "~*backup\.sql"                     1;
    "~*database\.sql"                   1;
    "~*\.sql\.gz"                       1;
    ~*/storage/app/backups/             1;
    "~*backup-.*\.zip"                  1;

    # Livewire
    ~*/app/Http/Livewire/               1;
    ~*/app/Livewire/                    1;
    ~*/livewire-tmp/                    1;
    "~*livewire.*fingerprint.*\.\./"    1;
    "~*/livewire/.*\.\./.*\.\."         1;

    # OAuth/Sanctum
    "~*/oauth/tokens(?:\?|$)"           1;
    "~*/oauth/clients(?:\?|$)"          1;
    "~*/oauth/personal-access-tokens(?:\?|$)" 1;

    # Queue
    ~*/storage/framework/queue/         1;
    ~*/failed_jobs                      1;

    # Version Disclosure
    "~*/laravel\.txt"                   1;
    ~*/VERSION                          1;
    "~*/version\.txt"                   1;

    # Laravel Packages
    "~*/admin/.*\.php"                  1;
    ~*/media/                           1;
    "~*/exports/.*\.xlsx"               1;
    "~*/exports/.*\.csv"                1;

    # Parameter Pollution
    "~*[?&]_method="                    1;
    "~*[?&](password|remember_token|api_token)=" 1;
    "~*[?&]X-CSRF-TOKEN="               1;
}

# ============================================================
# LARAVEL QUERY STRING ATTACKS
# ============================================================
map $query_string $laravel_query_attack {
    default 0;

    "~*select.*from.*users"             1;
    "~*where.*password"                 1;
    "~*page=-[0-9]+"                    1;
    ~*page=99999                        1;
    "~*(^|&)(is_admin|role|permissions)=" 1;
    "~*(^|&)(email_verified_at|remember_token)=" 1;
    "~*with\[.*\]\[.*\]="               1;
    "~*scopes?\[.*\]="                  1;
}

# ============================================================
# LARAVEL USER-AGENT ATTACKS
# ============================================================
map $http_user_agent $laravel_scanner {
    default 0;
    ~*LaravelScan                       1;
    ~*Laravel-Scanner                   1;
    ~*phpunit                           1;
    ~*PHPUnit                           1;
}
# ============================================================
# UPSTREAM: PHP-FPM Web Service (Livewire)
# ============================================================
upstream php_web {
    least_conn;
    server admin-web:9000 max_fails=3 fail_timeout=30s;
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# ============================================================
# UPSTREAM: PHP-FPM API Service (Dedicated)
# ============================================================
# ── nginx.conf ──────────────────────────────────────────────
# upstream php_api {
#     least_conn;
#     server rest-api:80 max_fails=3 fail_timeout=30s;
#     keepalive 64;
#     keepalive_requests 200;
#     keepalive_timeout 60s;
# }

# WebSocket upgrade map
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# Cache for static assets
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=static_cache:10m max_size=1g inactive=60m use_temp_path=off;



# ============================================================
# MAIN HTTPS SERVER
# ============================================================
server {
      listen 8443 ssl;
    listen [::]:8443 ssl;
    http2 on;

    # ============================================================
    # SSL CERTIFICATE CONFIGURATION
    # ============================================================
    ssl_certificate /etc/nginx/ssl/fullcertcahin-20250805.pem;
    ssl_certificate_key /etc/nginx/ssl/privateKey.pem;

    # ============================================================
    # BASIC SERVER CONFIGURATION
    # ============================================================
    root /app/public;
    index index.php index.html;
    charset utf-8;

    # ============================================================
    # IP BLACKLIST - Include external file
    # ============================================================
    # Uncomment to enable IP blacklist from external file
    # include /etc/nginx/conf.d/ip-blacklist.conf;

    # ============================================================
    # INLINE IP BLACKLIST (Quick Setup)
    # ============================================================
    # Block specific IP addresses
    # deny 1.2.3.4;
    # deny 5.6.7.8;
    # deny 10.20.30.0/24;
    # Block known malicious ranges (examples)
    deny 185.220.100.0/22; # Tor exit nodes
    deny 45.142.120.0/22; # Known bot network
    # Whitelist trusted IPs (these bypass rate limits)
    # allow 203.0.113.0/24;     # Your office
    # allow 198.51.100.50;      # Specific admin IP
    # ============================================================
    # ATTACK PATTERN BLOCKING
    # ============================================================
    # Block requests with attack patterns
    if ($attack_pattern) {
        return 403;
    }

    # Block bad bots
    if ($bad_bot) {
        return 403;
    }

    # Block suspicious HTTP methods
    if ($suspicious_method) {
        return 405;
    }

    # ============================================================
    # BLOCK LARAVEL-SPECIFIC ATTACKS
    # ============================================================

    # Block Laravel attack patterns
    if ($laravel_attack) {
        return 403;
    }

    # Block Laravel query string attacks
    if ($laravel_query_attack) {
        return 403;
    }

    # Block Laravel-specific scanners
    if ($laravel_scanner) {
        return 403;
    }

    # Block general attack patterns (your existing one)
    if ($attack_pattern) {
        return 403;
    }

    # ============================================================
    # RATE LIMITING & CONNECTION LIMITS
    # ============================================================
    # General rate limiting
    limit_req zone=general burst=50 nodelay;

    # Connection limit per IP
    limit_conn addr 20;

    # Bandwidth limit per connection (optional)
    # limit_rate 5m;  # 5MB/s per connection

    # ============================================================
    # SECURITY HEADERS
    # ============================================================
    # HSTS - Force HTTPS for 2 years
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    # Prevent clickjacking attacks
    add_header X-Frame-Options "SAMEORIGIN" always;

    # Prevent MIME-type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # Enable XSS protection in older browsers
    add_header X-XSS-Protection "1; mode=block" always;

    # Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy (adjust based on your application needs)
    add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; connect-src 'self' https: wss:;" always;

    # Restrict browser features
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Remove server version information
    server_tokens off;

    # ============================================================
    # REAL IP CONFIGURATION
    # ============================================================
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;
    set_real_ip_from 172.29.0.0/16; # Docker network
    set_real_ip_from 172.16.0.0/12; # Docker network
    set_real_ip_from 10.0.0.0/8; # Private network

    # If behind Cloudflare, add their IP ranges
    # set_real_ip_from 173.245.48.0/20;
    # set_real_ip_from 103.21.244.0/22;
    # ... (add all Cloudflare IPs)

    # Upload limits
    client_max_body_size 500M;
    client_body_buffer_size 128k;
    client_body_timeout 300s;
    client_header_timeout 300s;
    send_timeout 300s;

    # ============================================================
    # COMPRESSION (GZIP)
    # ============================================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/json
    application/javascript
    application/x-javascript
    application/xml
    application/xml+rss
    application/rss+xml
    font/truetype
    font/opentype
    application/vnd.ms-fontobject
    image/svg+xml;
    gzip_disable "msie6";

    # ============================================================
    # FASTCGI SETTINGS (for PHP-FPM)
    # ============================================================
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
    fastcgi_connect_timeout 300s;
    fastcgi_send_timeout 300s;
    fastcgi_read_timeout 300s;
    fastcgi_busy_buffers_size 32k;
    fastcgi_temp_file_write_size 256k;
    fastcgi_hide_header X-Powered-By;

    # ============================================================
    # NGINX HEALTH CHECK
    # ============================================================
    location = /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ============================================================
    # STATIC ASSETS - Serve directly from nginx
    # ============================================================
    # Vite/Laravel Mix build assets
    location ^~ /build/ {
        alias /app/public/build/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "Nginx-Static";
        try_files $uri $uri/ =404;
    }

    # General static assets with long cache
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|webp|svg|avif|woff|woff2|ttf|eot|otf)$ {
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri @web_backend;
    }

    location ~* \.(mp4|mp3|webm|ogg|mov|pdf)$ {
        # Rate limit downloads to prevent scraping
        limit_req zone=download burst=5 nodelay;
        expires 1y;
        access_log off;
        add_header Cache-Control "public";
        try_files $uri =404;
    }

    location ^~ /storage/ {
        # Rate limit storage access
        limit_req zone=download burst=10 nodelay;
        expires 1y;
        access_log off;
        add_header Cache-Control "public";
        try_files $uri =404;
    }

    # ============================================================
    # API ENDPOINTS - Route to Dedicated API Service
    # ============================================================
    location ^~ /api/ {
        # Stricter rate limiting for API
        limit_req zone=api burst=100 nodelay;
        limit_req zone=api_strict burst=5 delay=3;

        # Additional connection limit for API
        limit_conn perip 10;

        add_header X-Service-Type "API" always;
        try_files $uri @api_backend;
    }

    # API Authentication endpoints with stricter rate limiting
    location ~ ^/api/(login|register|password|token) {
        limit_req zone=login burst=3 nodelay;
        limit_conn perip 5;
        try_files $uri @api_backend;
    }

    # Dedicated API backend handler
    # ── default.conf ────────────────────────────────────────────
location @api_backend {
    # Use Docker's internal DNS — resolves at request time, not startup
    resolver 127.0.0.11 valid=10s ipv6=off;
    set $api_upstream http://rest-api:80;

    proxy_pass         $api_upstream;
    proxy_http_version 1.1;

    proxy_set_header   Host              $host;
    proxy_set_header   X-Real-IP         $remote_addr;
    proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto $scheme;
    proxy_set_header   Connection        "";

    proxy_set_header   HTTP_X_API_REQUEST "true";

    proxy_connect_timeout  10s;
    proxy_send_timeout     60s;
    proxy_read_timeout     60s;

    proxy_buffer_size      16k;
    proxy_buffers          4 32k;
    proxy_busy_buffers_size 32k;

    add_header X-Service-Type "API" always;
}



    # ============================================================
    # ADMIN PANEL - Extra Security & Rate Limiting
    # ============================================================
    location ^~ /admin {
        # Strict rate limiting for admin panel
        limit_req zone=admin burst=10 nodelay;
        limit_conn perip 3;

        # Optional: IP whitelist for admin panel
        # allow 203.0.113.0/24;  # Your office
        # deny all;

        try_files $uri $uri/ @web_backend;
    }

    location ^~ /administration {
        limit_req zone=admin burst=10 nodelay;
        limit_conn perip 3;
        try_files $uri $uri/ @web_backend;
    }

    # ============================================================
    # LIVEWIRE - Critical for real-time components
    # ============================================================
    location = /livewire/livewire.js {
        access_log off;
        expires 1d;
        add_header Cache-Control "public";
        try_files $uri @web_backend;
    }

    location = /livewire/livewire.min.js {
        access_log off;
        expires 1d;
        add_header Cache-Control "public";
        try_files $uri @web_backend;
    }

    location ^~ /livewire/update {
        # Rate limit Livewire updates
        limit_req zone=general burst=100 nodelay;

        include fastcgi_params;
        fastcgi_pass php_web;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTP_X_LIVEWIRE "true";
    }

    location ^~ /livewire/message/ {
        limit_req zone=general burst=100 nodelay;

        include fastcgi_params;
        fastcgi_pass php_web;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTP_X_LIVEWIRE "true";
    }

    location ^~ /livewire/upload-file {
        # Strict rate limiting for uploads
        limit_req zone=upload burst=3 nodelay;
        limit_conn perip 2;

        client_max_body_size 500M;
        include fastcgi_params;
        fastcgi_pass php_web;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTP_X_LIVEWIRE "true";
    }

    location ^~ /livewire/preview-file/ {
        include fastcgi_params;
        fastcgi_pass php_web;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    location ^~ /livewire/ {
        try_files $uri $uri/ @web_backend;
    }

    # ============================================================
    # SENSITIVE FILES BLOCKED
    # ============================================================
    location ~ /\.(?!well-known).* {
        deny all;
    }

    location ~* /\.(env|git|log|sql|sh|bak|swp|config)$ {
        deny all;
    }

    location ~* ^/(storage/framework|storage/logs|bootstrap/cache)/ {
        deny all;
    }

    # Block common exploit attempts
    location ~* (phpMyAdmin|phpmyadmin|pma|wp-admin|wp-login|xmlrpc\.php) {
        return 403;
    }

    # ============================================================
    # RATE-LIMITED ENDPOINTS (Authentication)
    # ============================================================
    location ~ ^/(login|authenticate)$ {
        limit_req zone=login burst=3 nodelay;
        limit_conn perip 3;
        try_files $uri $uri/ @web_backend;
    }

    location ~ ^/(register|signup)$ {
        # 1 per minute with burst of 5 = allows 5 registrations then 1/min
        limit_req zone=register burst=5 nodelay;
        limit_conn perip 2;
        try_files $uri $uri/ @web_backend;
    }

    location ~ ^/(password|forgot-password|reset-password)$ {
        # 1 per minute with burst of 3 = allows 3 resets then 1/min
        limit_req zone=password_reset burst=3 nodelay;
        limit_conn perip 2;
        try_files $uri $uri/ @web_backend;
    }

    location ~ ^/(two-factor-challenge|email/verification-notification)$ {
        limit_req zone=login burst=5 nodelay;
        try_files $uri $uri/ @web_backend;
    }

    # ============================================================
    # SEARCH ENDPOINTS - Prevent Abuse
    # ============================================================
    location ~ ^/(search|query|find) {
        limit_req zone=search burst=10 nodelay;
        try_files $uri $uri/ @web_backend;
    }


# ============================================================
    # NGINX STUB STATUS — for prometheus nginx-exporter
    # Only reachable from within the Docker network
    # ============================================================
    location = /nginx-stub-status {
        stub_status on;
        access_log off;
        allow 172.29.0.0/16;
        deny all;
    }

    # ============================================================
    # GRAFANA — Dashboard UI
    # ============================================================
    location /grafana/ {
        resolver 127.0.0.11 valid=10s ipv6=off;
        set $grafana_upstream http://grafana:3000;

        proxy_pass $grafana_upstream/;
        proxy_http_version 1.1;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Required for Grafana live dashboard WebSockets
        proxy_set_header Upgrade   $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }

    # ============================================================
    # PROMETHEUS — Metrics UI (internal network only)
    # ============================================================
    location /prometheus/ {
        allow 172.29.0.0/16;
        deny all;

        resolver 127.0.0.11 valid=10s ipv6=off;
        set $prom_upstream http://prometheus:9090;

        proxy_pass $prom_upstream/;
        proxy_http_version 1.1;

        proxy_set_header Host            $host;
        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    # ============================================================
    # WEB BACKEND FALLBACK
    # ============================================================
    location @web_backend {
        include fastcgi_params;
        fastcgi_pass php_web;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        add_header X-Service-Type "Web" always;
    }

    location / {
        try_files $uri $uri/ @web_backend;
    }

    location ~ \.php$ {
        try_files $uri =404;
        include fastcgi_params;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php_web;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # Prevent logs on favicon/robots
    location = /favicon.ico {
        access_log off;
        log_not_found off;
        try_files $uri =204;
    }

    location = /robots.txt {
        access_log off;
        log_not_found off;
        try_files $uri =204;
    }

    # ============================================================
    # ERROR PAGES
    # ============================================================
    error_page 403 /errors/403.html;
    error_page 404 /index.php;
    error_page 500 502 503 504 /errors/50x.html;
}
